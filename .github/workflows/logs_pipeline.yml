---
name: Logs Pipeline

on:
  push:
    branches: [main]
    paths:
      - 'logs/**/*.json'
      - 'output/**/*.json'
      - 'scripts/aggregate_logs.py'
      - 'scripts/summarize_logs.py'
      - '.github/workflows/logs_pipeline.yml'
  pull_request:
    branches: [main]
    paths:
      - 'logs/**/*.json'
      - 'output/**/*.json'
      - 'scripts/aggregate_logs.py'
      - 'scripts/summarize_logs.py'
      - '.github/workflows/logs_pipeline.yml'
  workflow_dispatch:

jobs:
  process_logs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run log aggregation
        id: aggregate
      - name: Run log aggregation
        id: aggregate
        run: |
          echo "::group::Running aggregate_logs.py"
          if ! python scripts/aggregate_logs.py; then
            echo "::error::‚ùå FAILED: scripts/aggregate_logs.py error"
            echo "::error::Log aggregation script failed"
            echo "aggregate_failed=true" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "‚úÖ SUCCESS: Log aggregation completed successfully"
            echo "aggregate_failed=false" >> $GITHUB_OUTPUT
          fi
          echo "::endgroup::"

      - name: Run log summarization
        id: summarize
        run: |
          echo "::group::Running summarize_logs.py"
          if ! python scripts/summarize_logs.py; then
            echo "::error::‚ùå FAILED: scripts/summarize_logs.py error"
            echo "::error::Log summarization script failed"
            echo "summarize_failed=true" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "‚úÖ SUCCESS: Log summarization completed successfully"
            echo "summarize_failed=false" >> $GITHUB_OUTPUT
          fi
          echo "::endgroup::"

      - name: Upload log artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: processed-logs
          path: |
            logs/aggregated_logs.csv
            logs/summary_report.json
          retention-days: 30

      - name: Display processing summary
        if: always()
        run: |
          echo "::group::üìä Log Processing Summary"
          agg_failed="${{ steps.aggregate.outputs.aggregate_failed }}"
          sum_failed="${{ steps.summarize.outputs.summarize_failed }}"

          if [ "$agg_failed" == "true" ]; then
            echo "Aggregate script status: ‚ùå FAILED"
          else
            echo "Aggregate script status: ‚úÖ SUCCESS"
          fi

          if [ "$sum_failed" == "true" ]; then
            echo "Summarize script status: ‚ùå FAILED"
          else
            echo "Summarize script status: ‚úÖ SUCCESS"
          fi

          if [ -f "logs/aggregated_logs.csv" ]; then
            row_count=$(wc -l < logs/aggregated_logs.csv)
            echo "Aggregated logs: $((row_count - 1)) data rows generated"
          fi

          if [ -f "logs/summary_report.json" ]; then
            echo "Summary report: Generated successfully"
          fi
          echo "::endgroup::"

          # Fail the workflow if either script failed
          if [ "$agg_failed" == "true" ] || [ "$sum_failed" == "true" ]; then
            echo "::error::‚ùå WORKFLOW FAILED: Scripts encountered errors"
            exit 1
          fi
